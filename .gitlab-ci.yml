stages:
  - prepare
  - build

variables:
  CACHE_FALLBACK_KEY: "default"
  # This variable has to be overridden to allow caching of conan packages, which must be updated the project dir to get cached
  CONAN_USER_HOME: "$CI_PROJECT_DIR/.conan"
  CONAN_USERNAME: "gitlab-ci"
  CONAN_REFERENCE: "advanced-flex-server/0.9"
  CONAN_CHANNEL: "gitlab-ci"
  CONAN_UPLOAD: "https://systemicai.jfrog.io/artifactory/api/conan/afs-http@True@systemicai-afshttp"
  CONAN_REMOTE: "https://systemicai.jfrog.io/artifactory/api/conan/afs-http@True@systemicai-afshttp"
  CC: "clang"
  CXX: "clang++"
  CONAN_CLANG_VERSIONS: "10"
  DEPENDENCIES: "${CI_PROJECT_DIR}/.deps-linux"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
  - "$CONAN_USER_HOME"
  - "$DEPENDENCIES"

.build-template: &build-template
  before_script:
  - sudo pip install --upgrade conan_package_tools
  - conan user
  - echo ${SHELL}
  - |
    if conan remote list | grep systemicai-afshttp;
    then
      echo Using existing remote
    else
      echo Setting up remote
      conan remote add systemicai-afshttp https://systemicai.jfrog.io/artifactory/api/conan/afs-http
      conan remote list
    fi
  # These two env vars are set in the CICD variables in gitlab
  - conan user -r systemicai-afshttp -p ${CONAN_PASSWORD} ${CONAN_LOGIN_USERNAME}
  # Set the dependencies directory before build so it uses the cached location
  - echo "${DEPENDENCIES}" > .deps

dependencies:
  stage: prepare
  image: conanio/clang10
  script:
  - mkdir -p build
  - pushd build
  - cmake ..
  - make dependencies # Populates the cache directory with built libraries for boost, etc
  - popd # build
  <<: *build-template

clang-10.0:
  artifacts:
    reports:
      junit: build/test-server-settings.report.xml
  stage: build
  image: conanio/clang10
  script:
  - mkdir -p build
  - pushd build
  - cmake ..
  - make
  - popd # build
  <<: *build-template
